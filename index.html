<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Undercover Royale</title>
  
  <!-- PWA & Mobile Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1c2c">
  <meta name="apple-mobile-web-app-title" content="Undercover">
  <meta name="application-name" content="Undercover Royale">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="https://img.icons8.com/?size=180&id=93NyEXRZ6Rk7&format=png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/?size=32&id=93NyEXRZ6Rk7&format=png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.icons8.com/?size=16&id=93NyEXRZ6Rk7&format=png">

  <!-- Inline Web App Manifest -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"Undercover Royale","short_name":"Undercover","start_url":".","display":"standalone","background_color":"#1a1c2c","theme_color":"#1a1c2c","orientation":"portrait","icons":[{"src":"https://img.icons8.com/?size=192&id=93NyEXRZ6Rk7&format=png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://img.icons8.com/?size=512&id=93NyEXRZ6Rk7&format=png","sizes":"512x512","type":"image/png","purpose":"any maskable"}]}'>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Fallback Font -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700;900&display=swap" rel="stylesheet">
  
  <style>
    /* PRODUCTION FONT LOADING */
    @font-face {
        font-family: 'Clash Regular';
        src: url('./assets/fonts/Clash_Regular.otf') format('opentype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }
    
    :root {
      --clash-blue: #4176FF;
      --clash-yellow: #FFB900;
      --clash-red: #FF4141;
      --clash-green: #4CB050;
      --clash-purple: #B026FF;
      --clash-darkblue: #1C598C;
    }
    * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        user-select: none;
    }
    input {
        user-select: text !important;
    }
    body {
      font-family: 'Clash Regular', 'Rubik', sans-serif;
      background-color: #1a1c2c;
      /* Using local asset path for production */
      background-image: url('./assets/background.png');
      background-repeat: repeat;
      background-size: 200px;
      background-position: center;
      touch-action: manipulation;
      color: white;
      overflow: hidden;
      height: 100dvh;
      width: 100vw;
      position: relative;
    }
    /* Dark overlay to ensure text readability over the background pattern */
    body::before {
        content: "";
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(26, 28, 44, 0.75);
        z-index: -1;
        backdrop-filter: blur(1px);
    }

    .clash-font {
        font-family: 'Clash Regular', 'Rubik', sans-serif;
        font-weight: 900;
        letter-spacing: 0.05em;
    }
    .text-shadow-heavy { text-shadow: 0 3px 0 #000; }
    .text-shadow-sm { text-shadow: 0 2px 0 rgba(0,0,0,0.5); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #1c1f3540; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #32365580; border-radius: 10px; }

    @keyframes popIn {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-pop { animation: popIn 0.2s ease-out forwards; }

    .watermark {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.3);
        z-index: 9999;
        font-weight: bold;
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* STAT GUESS specific colors */
    .stat-correct { background-color: var(--clash-green); }
    .stat-warm { background-color: var(--clash-yellow); color: black; }
    .stat-cold { background-color: var(--clash-red); }
    .sticky-col { position: sticky; left: 0; z-index: 10; }
    .stat-scroll-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .stat-row { display: grid; grid-template-columns: 100px 1fr; }
    .stat-data-grid { display: grid; grid-template-columns: repeat(7, 1fr); min-width: 420px; }

    /* Role Badge for Eliminated Players */
    .role-badge { 
        position: absolute; top: 2px; right: 2px; 
        font-size: 14px; line-height: 1; padding: 2px 4px;
        border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>
  <div id="root" class="h-full w-full"></div>
  <div class="watermark">BY VALE</div>

  <!-- Service Worker for PWA -->
  <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([`self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>e.respondWith(fetch(e.request)));`], {type: 'text/javascript'}))).catch(()=>{});
        });
    }
  </script>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef, memo } = React;

    // --- CONFIG ---
    const CARD_BASE_URL = "./assets/cards/";
    const CARD_DATA_URL = "./card_data.json";
    const SAD_GOBLIN_GIF = "https://media1.tenor.com/m/d8gHX1wRaaRAAAAC/clash-royale-goblin.gif"; 
    const CROWN_LOGO = "https://img.icons8.com/?size=100&id=93NyEXRZ6Rk7&format=png&color=000000";
    const MAX_GUESSES = 10;

    // --- UTILS ---
    const getCardUrl = (name) => name ? `${CARD_BASE_URL}${name.toLowerCase().replace(/\./g, '').replace(/\s+/g, '-')}.png` : null;
    const levenshteinDistance=(s,t)=>{if(!s.length)return t.length;if(!t.length)return s.length;const arr=[];for(let i=0;i<=t.length;i++){arr[i]=[i];for(let j=1;j<=s.length;j++){arr[i][j]=i===0?j:Math.min(arr[i-1][j]+1,arr[i][j-1]+1,arr[i-1][j-1]+(s[j-1]===t[i-1]?0:1))}}return arr[t.length][s.length]};
    const isGuessCorrect = (g, a, t=0.75) => { const G=g.trim().toLowerCase(),A=a.trim().toLowerCase();return !G?false:G===A?true:(1-levenshteinDistance(G,A)/Math.max(G.length,A.length))>=t; };

    const WORD_PAIRS = [
      { civilian: "Knight", undercover: "Mega Knight" }, { civilian: "Musketeer", undercover: "Archers" }, { civilian: "Giant", undercover: "Golem" }, { civilian: "Wizard", undercover: "Ice Wizard" },
      { civilian: "Baby Dragon", undercover: "Inferno Dragon" }, { civilian: "Skeleton Army", undercover: "Goblin Gang" }, { civilian: "Prince", undercover: "Dark Prince" }, { civilian: "Fireball", undercover: "Rocket" },
      { civilian: "Tesla", undercover: "Inferno Tower" }, { civilian: "Minions", undercover: "Bats" }, { civilian: "Hog Rider", undercover: "Ram Rider" }, { civilian: "P.E.K.K.A", undercover: "Mini P.E.K.K.A" },
      { civilian: "Barbarians", undercover: "Elite Barbarians" }, { civilian: "Cannon", undercover: "Mortar" }, { civilian: "Princess", undercover: "Archer Queen" }, { civilian: "Goblins", undercover: "Spear Goblins" },
      { civilian: "Balloon", undercover: "Skeleton Barrel" }, { civilian: "Valkyrie", undercover: "Executioner" }, { civilian: "Zap", undercover: "Lightning" }, { civilian: "Witch", undercover: "Night Witch" },
      { civilian: "Miner", undercover: "Goblin Drill" }, { civilian: "Arrows", undercover: "The Log" }, { civilian: "Royal Giant", undercover: "Electro Giant" }, { civilian: "Bandit", undercover: "Golden Knight" },
      { civilian: "Electro Dragon", undercover: "Skeleton Dragons" }, { civilian: "Magic Archer", undercover: "Dart Goblin" }, { civilian: "Royal Hogs", undercover: "Battle Ram" }, { civilian: "Poison", undercover: "Earthquake" },
      { civilian: "Tombstone", undercover: "Furnace" }, { civilian: "Mega Minion", undercover: "Phoenix" }, { civilian: "Ice Spirit", undercover: "Electro Spirit" },
    ];

    const ROLES = { CIVILIAN: 'civilian', UNDERCOVER: 'undercover', MR_WHITE: 'mr_white', JESTER: 'jester', BODYGUARD: 'bodyguard', HUNTER: 'hunter', ELECTRO: 'electro' };
    const MODES = { REGULAR: 'regular', CHAOS: 'chaos', STAT_GUESS: 'stat_guess' };

    const getRoleBadge = (role) => {
        const badgeMap = {
            [ROLES.CIVILIAN]: { icon: 'üõ°Ô∏è', color: 'bg-[#4176FF]' }, [ROLES.BODYGUARD]: { icon: 'üõ°Ô∏è', color: 'bg-[#4176FF]' }, [ROLES.HUNTER]: { icon: 'üõ°Ô∏è', color: 'bg-[#4176FF]' },
            [ROLES.UNDERCOVER]: { icon: 'üë∫', color: 'bg-[#FF4141]' }, [ROLES.MR_WHITE]: { icon: '‚¨ú', color: 'bg-slate-500' }, [ROLES.JESTER]: { icon: 'üÉè', color: 'bg-[#4CB050]' }, [ROLES.ELECTRO]: { icon: '‚ö°', color: 'bg-[#1C598C]' },
        };
        return badgeMap[role] || { icon: '?', color: 'bg-gray-500' };
    };

    // --- COMPONENTS ---
    const Container = ({ children, className = "" }) => (<div className={`h-full flex flex-col px-4 pt-4 pb-10 sm:p-6 max-w-md mx-auto w-full ${className}`}>{children}</div>);
    const CardComp = ({ children, className = "", color = "blue", noPadding = false }) => {
        const bgColors = { blue: "bg-[#323655]/95 border-[#1c1f35]", red: "bg-[#553232]/95 border-[#2a1515]", gold: "bg-[#554b32]/95 border-[#2a2515]", gray: "bg-slate-700/95 border-slate-500", green: "bg-[#2e4a2e]/95 border-[#1e3a1e]", purple: "bg-[#4A2E75]/95 border-[#2E1A4A]", darkblue: "bg-[#1C598C]/95 border-[#144265]", stats: "bg-[#183918]/95 border-[#0d280d]" }
        return (<div className={`${bgColors[color] || bgColors.blue} border-4 rounded-3xl ${noPadding ? '' : 'p-4 sm:p-6'} shadow-[0_6px_0_rgba(0,0,0,0.3)] backdrop-blur-md ${className}`}>{children}</div>);
    };
    const Button = ({ onClick, color = "blue", children, full = false, disabled = false, size = "xl", className = "" }) => {
        const s = { blue: "bg-[#4176FF] border-[#3565E0] shadow-[0_4px_0_#2448A8]", yellow: "bg-[#FFB900] border-[#E5A800] shadow-[0_4px_0_#B38300] text-black", red: "bg-[#FF4141] border-[#E03535] shadow-[0_4px_0_#A82424]", green: "bg-[#4CB050] border-[#388E3C] shadow-[0_4px_0_#1B5E20]", gray: "bg-slate-600 border-slate-700 shadow-[0_4px_0_#334155] opacity-50 cursor-not-allowed", purple: "bg-[#B026FF] border-[#8A1DC7] shadow-[0_4px_0_#57127F]", darkblue: "bg-[#1C598C] border-[#144265] shadow-[0_4px_0_#0C2740]" };
        return (<button onClick={disabled ? null : onClick} className={`clash-font uppercase tracking-wider py-3 px-4 rounded-xl border-b-4 active:translate-y-1 active:border-b-0 active:shadow-none active:mt-1 transition-all duration-100 flex items-center justify-center gap-2 text-${size} ${disabled ? s.gray : s[color]} ${full ? 'w-full' : ''} ${color === 'yellow' ? 'text-shadow-none' : 'text-shadow-sm'} ${className}`} style={{ minHeight: '55px' }}>{children}</button>);
    };
    const Modal = ({ onClose, title, children }) => (<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-pop backdrop-blur-sm" onClick={onClose}><div className="w-full max-w-md" onClick={e => e.stopPropagation()}><CardComp color="blue" className="max-h-[80vh] flex flex-col"><header className="flex justify-between items-center mb-4 flex-shrink-0"><h2 className="clash-font text-2xl text-[#FFB900] text-shadow-heavy">{title}</h2><button onClick={onClose} className="text-3xl opacity-70 hover:opacity-100">&times;</button></header><div className="overflow-y-auto flex-1 pr-2">{children}</div></CardComp></div></div>);

    const getStatusClass = (status) => status === 'correct' ? 'stat-correct' : (status === 'warm' ? 'stat-warm' : 'stat-cold');
    const ScrollingHeader = memo(() => (<div className="stat-data-grid text-center clash-font text-[10px] sm:text-xs mb-1 border-b border-white/50 pb-1"><div className="opacity-70">Elixir üíß</div><div className="opacity-70">Rarity</div><div className="opacity-70">Type</div><div className="opacity-70">Targets</div><div className="opacity-70">Range</div><div className="opacity-70">Speed</div><div className="opacity-70">Hit Spd</div></div>));
    const ScrollingRow = memo(({ guess }) => (<div className="stat-data-grid text-center text-[10px] sm:text-xs font-bold gap-1">{['elixir', 'rarity', 'type', 'targets', 'range_type', 'speed', 'hit_speed'].map(key => { const f = guess.feedback[key]; return (<div key={key} className={`${getStatusClass(f?.status)} rounded-lg p-1 flex items-center justify-center h-full relative`}><span className="truncate max-w-[85%]">{f?.value || '-'}</span>{f?.direction && <span className="absolute right-0.5 bottom-0.5 text-[8px] opacity-80">{f.direction}</span>}</div>); })}</div>));

    // --- APP ---
    const App = () => {
      const [cardData, setCardData] = useState([]);
      const [gameState, setGameState] = useState('setup');
      const [gameMode, setGameMode] = useState(MODES.REGULAR);
      const [settings, setSettings] = useState({ total: 5, undercover: 1, mrWhite: 0, jester: 0, bodyguard: 0, hunter: 0, electro: 0 });
      const [customNames, setCustomNames] = useState(Array(15).fill('').map((_, i) => `Player ${i + 1}`));
      const [players, setPlayers] = useState([]);
      const [currentRevealIndex, setCurrentRevealIndex] = useState(0);
      const [isRevealing, setIsRevealing] = useState(false);
      const [winnerData, setWinnerData] = useState({ team: null, reason: null });
      const [selectedPlayerId, setSelectedPlayerId] = useState(null);
      const [justEliminated, setJustEliminated] = useState([]);
      const [currentWords, setCurrentWords] = useState({ civilian: '', undercover: '' });
      const [mrWhiteGuess, setMrWhiteGuess] = useState('');
      const [showRules, setShowRules] = useState(false);
      const [showNames, setShowNames] = useState(false);
      const [timer, setTimer] = useState(180); 
      const timerRef = useRef(null);
      const [targetCard, setTargetCard] = useState(null);
      const [guesses, setGuesses] = useState([]);
      const [guessInput, setGuessInput] = useState('');

      useEffect(() => { fetch(CARD_DATA_URL).then(res => res.ok ? res.json() : []).then(setCardData).catch(() => {}); }, []);
      useEffect(() => { if (gameState === 'discussing') { timerRef.current = setInterval(() => setTimer(p => { if(p<=1){clearInterval(timerRef.current);return 0;} return p-1; }), 1000); } else { clearInterval(timerRef.current); } return () => clearInterval(timerRef.current); }, [gameState]);

      const getMaxImpostors = (total, key) => {
          if (key === 'total') return Math.floor((total - 1) / 2);
          const others = (settings.undercover + settings.mrWhite + settings.jester + settings.bodyguard + settings.hunter + settings.electro) - settings[key];
          return Math.max(0, total - 1 - others);
      }
      const updateSetting = (k, v) => setSettings(p => { const n = { ...p, [k]: parseInt(v)||0 }; if(k==='total') n.total = Math.max(3, Math.min(15, n.total)); else if(n[k] > getMaxImpostors(n.total, k)) n[k] = getMaxImpostors(n.total, k); return n; });
      const startGame = () => {
          if (gameMode === MODES.STAT_GUESS) {
              if (cardData.length < 5) { alert("Card data missing. Check card_data.json on GitHub."); return; }
              const eligible = cardData.filter(c => c.elixir !== "Variable" && c.elixir !== "N/A");
              setTargetCard(eligible[Math.floor(Math.random() * eligible.length)]);
              setGuesses([]); setGuessInput(''); setGameState('stat_guess_game'); return;
          }
          const pair = WORD_PAIRS[Math.floor(Math.random() * WORD_PAIRS.length)];
          const swap = Math.random() > 0.5;
          const words = { [ROLES.CIVILIAN]: swap ? pair.undercover : pair.civilian, [ROLES.UNDERCOVER]: swap ? pair.civilian : pair.undercover, [ROLES.MR_WHITE]: null, [ROLES.JESTER]: 'Goblins', [ROLES.BODYGUARD]: 'Royal Recruits', [ROLES.HUNTER]: 'Hunter', [ROLES.ELECTRO]: 'Electro Wizard' };
          setCurrentWords({ civilian: words[ROLES.CIVILIAN], undercover: words[ROLES.UNDERCOVER] });
          let roles = [...Array(settings.undercover).fill(ROLES.UNDERCOVER), ...Array(settings.mrWhite).fill(ROLES.MR_WHITE)];
          if (gameMode === MODES.CHAOS) roles.push(...Array(settings.jester).fill(ROLES.JESTER), ...Array(settings.bodyguard).fill(ROLES.BODYGUARD), ...Array(settings.hunter).fill(ROLES.HUNTER), ...Array(settings.electro).fill(ROLES.ELECTRO));
          while (roles.length < settings.total) roles.push(ROLES.CIVILIAN);
          for (let i = roles.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [roles[i], roles[j]] = [roles[j], roles[i]]; }
          let newPlayers = roles.map((r, i) => ({ id: i, name: customNames[i], role: r, word: words[r], isAlive: true, isZapped: false, isKing: false, avatar: ['üßô‚Äç‚ôÇÔ∏è','üßù‚Äç‚ôÄÔ∏è','ü§¥','üë∏','üßõ‚Äç‚ôÇÔ∏è','üßü‚Äç‚ôÇÔ∏è','üßû‚Äç‚ôÇÔ∏è','üßö‚Äç‚ôÄÔ∏è'][i%8] }));
          if (gameMode === MODES.CHAOS) {
              if (Math.random() < 0.05) newPlayers[Math.floor(Math.random() * newPlayers.length)].isKing = true;
              const civs = newPlayers.filter(p => p.role === ROLES.CIVILIAN);
              if (civs.length >= 2 && Math.random() < 0.05) { const p1 = civs[Math.floor(Math.random()*civs.length)], p2 = civs.filter(c=>c.id!==p1.id)[Math.floor(Math.random()*(civs.length-1))]; newPlayers = newPlayers.map(p => p.id===p1.id ? {...p, mirrorId:p2.id, mirrorName:p2.name} : (p.id===p2.id ? {...p, mirrorId:p1.id, mirrorName:p1.name} : p)); }
          }
          newPlayers = newPlayers.map(p => { if(p.role===ROLES.BODYGUARD){ const t = newPlayers.filter(x=>x.id!==p.id); if(t.length) return {...p, targetId: t[Math.floor(Math.random()*t.length)].id}; } return p; });
          setPlayers(newPlayers); setCurrentRevealIndex(0); setIsRevealing(false); setGameState('reveal'); setSelectedPlayerId(null); setMrWhiteGuess(''); setTimer(180);
      };

      // --- GAMEPLAY LOOP ---
      const handleNextReveal = () => {
          setIsRevealing(false);
          const nextIndex = currentRevealIndex + 1;
          if (nextIndex < players.length) {
              setCurrentRevealIndex(nextIndex);
          } else {
              setGameState('discussing');
          }
      };

      const handleElectroZap = (targetId) => {
           setPlayers(prev => prev.map(p => p.id === targetId ? { ...p, isZapped: true } : p));
           handleNextReveal();
      }

      const eliminatePlayer = () => {
          if (selectedPlayerId === null) return;
          const p = players.find(x => x.id === selectedPlayerId);
          if (p.role === ROLES.JESTER) { setJustEliminated([p]); setWinnerData({team:'JESTER', reason:'Jester tricked you!'}); setGameState('game_over'); return; }
          if (p.role === ROLES.MR_WHITE) { setJustEliminated([p]); setGameState('mr_white_guess'); setSelectedPlayerId(null); return; }
          if (p.role === ROLES.HUNTER) { setJustEliminated([p]); setGameState('hunter_revenge'); setSelectedPlayerId(null); return; }
          let toKill = [p];
          players.filter(bg => bg.role === ROLES.BODYGUARD && bg.isAlive && bg.targetId === p.id).forEach(bg => toKill.push(bg));
          finalizeElimination(toKill);
      };
      const finalizeElimination = (killed) => {
          setJustEliminated(killed);
          const updated = players.map(p => killed.some(k => k.id === p.id) ? { ...p, isAlive: false } : p);
          setPlayers(updated);
          const alive = updated.filter(p => p.isAlive);
          const imp = alive.filter(p => [ROLES.UNDERCOVER, ROLES.MR_WHITE, ROLES.ELECTRO].includes(p.role)).length;
          const civ = alive.filter(p => [ROLES.CIVILIAN, ROLES.BODYGUARD, ROLES.HUNTER].includes(p.role)).length;
          setSelectedPlayerId(null);
          if (imp === 0 && civ > 0) { setWinnerData({team:'CIVILIANS', reason:'Impostors eliminated!'}); setGameState('game_over'); }
          else if (imp >= civ && imp > 0) { setWinnerData({team:'IMPOSTORS', reason:'Impostors have taken over!'}); setGameState('game_over'); }
          else if (civ === 0 && imp === 0) { setWinnerData({team:'NO ONE', reason:'Mutual destruction!'}); setGameState('game_over'); }
          else setGameState('round_summary');
      };

      const handleHunterShot = (targetId) => {
          const hunter = justEliminated.find(p => p.role === ROLES.HUNTER);
          const target = players.find(p => p.id === targetId);
          let toKill = [hunter, target];
          players.filter(bg => bg.role === ROLES.BODYGUARD && bg.isAlive && bg.targetId === target.id).forEach(bg => toKill.push(bg));
          finalizeElimination(toKill);
      }

      const handleMrWhiteGuess = () => {
          if (isGuessCorrect(mrWhiteGuess, currentWords.civilian)) { setWinnerData({team:'MR. WHITE', reason:`Mr. White guessed ${currentWords.civilian}!`}); setGameState('game_over'); }
          else { finalizeElimination(justEliminated); }
      }
      
      const handleStatGuess = () => {
          const gCard = cardData.find(c => c.name.toLowerCase() === guessInput.trim().toLowerCase());
          if (!gCard) { alert("Invalid card name!"); return; }
          let feedback = {}, isWin = true;
          ['elixir','rarity','type','targets','range_type','speed','hit_speed'].forEach(k => {
              const tV = targetCard[k], gV = gCard[k];
              if ((k === 'elixir' || k === 'hit_speed') && !isNaN(parseFloat(tV)) && !isNaN(parseFloat(gV))) {
                  const tN = parseFloat(tV), gN = parseFloat(gV);
                  if (gN === tN) feedback[k] = { status: 'correct', value: gV };
                  else { feedback[k] = { status: Math.abs(gN - tN) <= 1.0 ? 'warm' : 'cold', value: gV, direction: gN < tN ? '‚ñ≤' : '‚ñº' }; isWin = false; }
              } else {
                  if (gV === tV) feedback[k] = { status: 'correct', value: gV };
                  else { feedback[k] = { status: 'cold', value: gV }; isWin = false; }
              }
          });
          const newGuesses = [{ cardName: gCard.name, feedback, isWin }, ...guesses];
          setGuesses(newGuesses); setGuessInput('');
          if (isWin) { setWinnerData({ team: 'GUESSERS', reason: `Correct! It was ${targetCard.name}!` }); setGameState('game_over'); }
          else if (newGuesses.length >= MAX_GUESSES) { setWinnerData({ team: 'FAIL', reason: `Out of tries! It was ${targetCard.name}.` }); setGameState('game_over'); }
      };

      if (gameState==='setup') {
          const totalEnemies = settings.undercover + settings.mrWhite + settings.jester + settings.hunter + settings.electro;
          const isValid = settings.total > 2 && totalEnemies > 0;
          const battleColor = gameMode === MODES.CHAOS ? "purple" : (gameMode === MODES.STAT_GUESS ? "green" : "yellow");
          const Slider = ({k, l, c, max, icon}) => (<div className="touch-pan-y"><div className="flex justify-between clash-font text-sm mb-1"><span className={`${c} flex items-center gap-1`}>{icon} {l}</span><span>{settings[k]}</span></div><input type="range" min={0} max={max} value={settings[k]} onChange={(e)=>updateSetting(k, e.target.value)} className={`w-full h-4 bg-[#1c1f35]/50 rounded-full accent-${c.split('-')[0]}-500`}/></div>);
          return (<Container className="overflow-y-auto animate-pop"><header className="text-center mb-4 mt-2 flex-shrink-0"><h1 className="clash-font text-white text-shadow-heavy leading-none flex items-center justify-center gap-2 text-2xl sm:text-5xl"><img src={CROWN_LOGO} alt="Logo" className="w-8 h-8 sm:w-10 sm:h-10"/><span>UNDERCOVER</span><div className="text-[#FFB900] -mt-1 sm:-mt-2">ROYALE</div></h1></header><div className="flex bg-[#1c1f35]/50 p-1 rounded-xl mb-4 clash-font text-sm sm:text-base flex-shrink-0"><button onClick={()=>setGameMode(MODES.REGULAR)} className={`flex-1 py-2 rounded-lg ${gameMode===MODES.REGULAR?'bg-blue-600 text-white':'text-slate-400'}`}>REGULAR</button><button onClick={()=>setGameMode(MODES.CHAOS)} className={`flex-1 py-2 rounded-lg ${gameMode===MODES.CHAOS?'bg-purple-600 text-white':'text-slate-400'}`}>CHAOS</button><button onClick={()=>setGameMode(MODES.STAT_GUESS)} className={`flex-1 py-2 rounded-lg ${gameMode===MODES.STAT_GUESS?'bg-green-600 text-white':'text-slate-400'}`}>STAT GUESS</button></div>{gameMode!==MODES.STAT_GUESS?(<CardComp className="space-y-4 mb-4 flex-1 flex flex-col overflow-y-auto min-h-0"><div className="touch-pan-y"><div className="flex justify-between clash-font text-lg mb-1"><span className="text-blue-400">üë• Total Players</span><span>{settings.total}</span></div><input type="range" min={3} max={15} value={settings.total} onChange={(e)=>updateSetting('total',e.target.value)} className="w-full h-6 bg-[#1c1f35]/50 rounded-full accent-[#FFB900]"/></div><div className="grid grid-cols-2 gap-x-4 gap-y-3"><Slider k='undercover' l='Undercover' c='text-red-400' max={getMaxImpostors(settings.total,'undercover')} icon='üë∫'/><Slider k='mrWhite' l='Mr. White' c='text-slate-300' max={getMaxImpostors(settings.total,'mrWhite')} icon='‚¨ú'/>{gameMode===MODES.CHAOS&&<><Slider k='jester' l='Jester' c='text-green-400' max={1} icon='üÉè'/><Slider k='bodyguard' l='Bodyguard' c='text-yellow-400' max={1} icon='üõ°Ô∏è'/><Slider k='hunter' l='Hunter' c='text-purple-400' max={1} icon='ü§†'/><Slider k='electro' l='E-Wizard' c='text-darkblue-400' max={1} icon='‚ö°'/></>}</div><div className="flex justify-center pt-2 mt-auto"><Button color="blue" size="lg" onClick={()=>setShowNames(true)} className="py-2 px-6 text-base">EDIT NAMES ‚úçÔ∏è</Button></div></CardComp>):(<CardComp color="stats" className="space-y-4 mb-4 flex-1 flex flex-col items-center justify-center text-center"><h3 className="clash-font text-3xl mb-2">CLASH WORDLE</h3><div className="text-5xl mb-4">ü§î</div><div className="mt-4 p-2 bg-black/20 rounded-lg text-sm">{cardData.length>0?<span className="text-green-400">‚úÖ Loaded {cardData.length} cards</span>:<span className="text-red-400 animate-pulse">‚åõ Loading data...</span>}</div></CardComp>)}<div className="flex-shrink-0 space-y-3"><Button full color={isValid||gameMode===MODES.STAT_GUESS?battleColor:"gray"} disabled={gameMode!==MODES.STAT_GUESS&&!isValid} onClick={startGame}>{gameMode===MODES.STAT_GUESS?"START GUESSING! üéØ":(isValid?"BATTLE! ‚öîÔ∏è":"AT LEAST ONE ENEMY REQUIRED!")}</Button><Button full color="blue" onClick={()=>setShowRules(true)} className="py-2 min-h-[45px] text-base">HOW TO PLAY ‚ÑπÔ∏è</Button></div>{showRules&&<Modal title="HOW TO PLAY" onClose={()=>setShowRules(false)}><div className="space-y-4 text-sm opacity-90"><p><strong>Goal:</strong> Civilians find impostors. Impostors outnumber civilians.</p><ul className="list-disc pl-4"><li>Civilian: Standard card.</li><li>Undercover: Different card.</li><li>Mr. White: NO card.</li><li>Jester: Wins if voted out.</li><li>Bodyguard: Protects one player.</li><li>Hunter: Gets a last shot if voted out.</li><li>Electro Wizard: Silences one player.</li><li>King: Double vote.</li></ul></div></Modal>}{showNames&&<Modal title="PLAYER NAMES" onClose={()=>setShowNames(false)}><div className="space-y-2">{Array(settings.total).fill(0).map((_,i)=>(<div key={i} className="flex items-center gap-2"><span className="w-6 opacity-50">{i+1}.</span><input type="text" value={customNames[i]} onChange={(e)=>updateName(i,e.target.value)} className="flex-1 bg-[#1a1c2c] border-2 border-[#323655] rounded-lg px-2 py-1 text-white focus:border-[#FFB900] outline-none"/></div>))}</div></Modal>}</Container>);
      }

      if (gameState === 'reveal') {
          const p = players[currentRevealIndex];
          const isSpecial = [ROLES.MR_WHITE, ROLES.JESTER, ROLES.BODYGUARD, ROLES.HUNTER, ROLES.ELECTRO].includes(p.role);
          const potZap = players.filter(pl => !pl.isZapped && pl.id !== p.id);
          const needsZap = p.role === ROLES.ELECTRO && potZap.length > 0;
          let rTxt = "Memorize your card!", rCol = "text-slate-400", cCol = 'blue', cCont = <img src={getCardUrl(p.word)} className="w-32 sm:w-40 h-auto drop-shadow-lg" onError={(e)=>{e.target.style.display='none';e.target.nextSibling.style.display='block'}}/>, eAct = null;
          if (p.role === ROLES.MR_WHITE) { rTxt = "You are Mr. White!"; rCol = "text-white"; cCol = 'gray'; cCont = <div className="text-8xl mb-4">‚ùî</div>; }
          else if (p.role === ROLES.JESTER) { rTxt = "You are the Jester!"; rCol = "text-green-400"; cCol = 'green'; cCont = <img src={getCardUrl('goblins')} className="w-32 h-auto drop-shadow-lg"/>; }
          else if (p.role === ROLES.HUNTER) { rTxt = "You are the Hunter!"; rCol = "text-purple-400"; cCol = 'purple'; cCont = <img src={getCardUrl('hunter')} className="w-32 h-auto drop-shadow-lg"/>; }
          else if (p.role === ROLES.BODYGUARD) { rTxt = `Protect ${players.find(pl=>pl.id===p.targetId)?.name||"someone"}!`; rCol = "text-yellow-400"; cCol = 'gold'; cCont = <img src={getCardUrl('royal-recruits')} className="w-32 h-auto drop-shadow-lg"/>; }
          else if (p.role === ROLES.ELECTRO) { rTxt = needsZap?"Choose a player to ZAP!":"Mission complete."; rCol = "text-darkblue-400"; cCol = 'darkblue'; cCont = <img src={getCardUrl('electro-wizard')} className="w-32 h-auto drop-shadow-lg"/>; if(needsZap) eAct = (<div className="grid grid-cols-3 gap-2 w-full mt-4">{potZap.map(pl=>(<button key={pl.id} onClick={()=>handleElectroZap(pl.id)} className="bg-[#1C598C] border-2 border-blue-400 rounded-lg p-2 text-xs font-bold">{pl.name}</button>))}</div>); }
          else if (p.mirrorId !== undefined) rTxt = `MIRROR! ${p.mirrorName} has same word.`;

          return (<Container><h2 className="clash-font text-center text-xl text-[#FFB900] mb-4">REVEAL {currentRevealIndex + 1}/{players.length}</h2>{isRevealing ? (<CardComp color={cCol} className="flex-1 flex flex-col items-center justify-center mb-6 animate-pop"><div className="mb-4 text-lg font-bold text-slate-400 tracking-widest uppercase">SECRET IDENTITY</div><div className="flex-1 flex flex-col items-center justify-center">{cCont}{!isSpecial && <div className="clash-font text-2xl text-[#FFB900] px-2 mt-4 text-center">{p.word}</div>}{isSpecial && <div className="clash-font text-3xl text-white mt-2">{p.role.toUpperCase().replace('_',' ')}</div>}</div><div className={`mt-4 font-bold text-xl ${rCol} text-center px-2`}>{rTxt}</div>{eAct}</CardComp>) : (<CardComp className="flex-1 flex flex-col items-center justify-center mb-6 animate-pop"><div className="absolute top-4 left-4 font-bold text-slate-500">#{p.id+1}</div><div className="text-center"><div className="text-7xl mb-6 opacity-50">ü§ê</div><h3 className="text-2xl font-bold">Pass device to</h3><h1 className="clash-font text-4xl text-[#FFB900] mt-2 truncate px-4">{p.name}</h1></div></CardComp>)}<div className="flex-shrink-0">{!needsZap && <Button full color={!isRevealing?"blue":"yellow"} onClick={!isRevealing?()=>setIsRevealing(true):handleNextReveal}>{!isRevealing?"SHOW IDENTITY üëÅÔ∏è":"GOT IT! üëå"}</Button>}</div></Container>);
      }

      if (gameState === 'discussing' || gameState === 'voting' || gameState === 'hunter_revenge') {
          return (<Container><header className="text-center mb-4"><h2 className="clash-font text-2xl text-[#FFB900]">{gameState==='discussing'?'DISCUSSION':(gameState==='hunter_revenge'?'HUNTER REVENGE':'ELIMINATION')}</h2>{gameState==='discussing'&&<div className={`text-xl font-bold ${timer<30?'text-red-500 animate-pulse':'text-white'}`}>‚è±Ô∏è {Math.floor(timer/60)}:{(timer%60).toString().padStart(2,'0')}</div>}{gameState==='hunter_revenge'&&<p className="text-orange-400 font-bold animate-pulse">Hunter, choose your last target!</p>}</header><div className="flex-1 overflow-y-auto grid grid-cols-3 gap-2 content-start pb-2">{players.map(p=>(<button key={p.id} disabled={!p.isAlive||gameState==='discussing'} onClick={()=>(gameState==='voting'||gameState==='hunter_revenge')&&setSelectedPlayerId(p.id)} className={`relative p-1 rounded-xl border-2 flex flex-col items-center justify-center min-h-[90px] backdrop-blur-sm ${!p.isAlive?'bg-slate-800/50 border-slate-900 opacity-40 grayscale':(gameState==='voting'||gameState==='hunter_revenge')?(selectedPlayerId===p.id?'bg-[#323655]/90 border-[#FFB900] scale-105 z-10':'bg-[#323655]/80 border-[#FF4141] active:scale-95'):'bg-[#323655]/80 border-[#1c1f35]'}`}><div className="text-3xl mb-1 relative">{p.avatar}{p.isKing&&gameState==='voting'&&<span className="absolute -top-3 -right-3 text-2xl">üëë</span>}{p.isZapped&&gameState==='discussing'&&<span className="absolute -bottom-1 -right-1 text-xl">‚ö°</span>}</div><div className="clash-font text-[10px] sm:text-xs truncate w-full text-center px-1">{p.name}</div>{!p.isAlive&&<div className="absolute inset-0 flex items-center justify-center text-4xl opacity-50">üíÄ</div>}{!p.isAlive&&<span className={`role-badge ${[ROLES.CIVILIAN,ROLES.BODYGUARD,ROLES.HUNTER].includes(p.role)?'bg-[#4176FF]':(p.role===ROLES.UNDERCOVER?'bg-[#FF4141]':(p.role===ROLES.MR_WHITE?'bg-slate-500':(p.role===ROLES.JESTER?'bg-[#4CB050]':'bg-[#1C598C]')))}`}>{getRoleBadge(p.role).icon}</span>}</button>))}</div><div className="mt-4">{gameState==='discussing'?<Button full color="red" onClick={()=>setGameState('voting')}>START VOTING üó≥Ô∏è</Button>:(selectedPlayerId!==null?(gameState==='hunter_revenge'?<Button full color="purple" onClick={()=>handleHunterShot(selectedPlayerId)}>SHOOT! üî´</Button>:<Button full color="red" onClick={eliminatePlayer}>ELIMINATE {players.find(p=>p.id===selectedPlayerId)?.name} üíÄ</Button>):(gameState==='voting'?<Button full color="blue" onClick={()=>setGameState('discussing')}>BACK TO DISCUSS üîô</Button>:null))}</div></Container>);
      }

      if (gameState === 'mr_white_guess') return (<Container className="animate-pop"><header className="text-center mb-8 mt-6"><div className="text-6xl mb-4">‚ùî</div><h1 className="clash-font text-3xl text-white mb-2">LAST CHANCE!</h1><p className="font-bold opacity-90">{justEliminated[0]?.name} is Mr. White!</p></header><CardComp color="gray" className="flex-1 flex flex-col items-center justify-center mb-8"><h3 className="text-xl font-bold text-center mb-6">Guess Civilian Card to win!</h3><input type="text" value={mrWhiteGuess} onChange={(e)=>setMrWhiteGuess(e.target.value)} placeholder="Type guess..." className="w-full p-4 rounded-xl bg-[#1c1f35]/80 border-4 border-[#323655] text-white text-center text-2xl clash-font outline-none focus:border-[#FFB900]"/></CardComp><div className="flex-shrink-0"><Button full color="yellow" onClick={handleMrWhiteGuess}>SUBMIT GUESS üéØ</Button></div></Container>);

      if (gameState === 'round_summary') return (<Container className="animate-pop"><header className="text-center mb-4 mt-4"><h1 className="clash-font text-3xl text-white">ELIMINATED!</h1></header><div className="flex-1 overflow-y-auto space-y-4">{justEliminated.map(p=><CardComp key={p.id} color={[ROLES.CIVILIAN,ROLES.BODYGUARD,ROLES.HUNTER].includes(p.role)?'blue':(p.role===ROLES.MR_WHITE?'gray':(p.role===ROLES.JESTER?'green':(p.role===ROLES.HUNTER?'purple':(p.role===ROLES.ELECTRO?'darkblue':'red'))))} className="flex flex-col items-center justify-center py-4"><h2 className="clash-font text-2xl text-white mb-2">{p.name}</h2><div className="text-7xl mb-2">{p.role===ROLES.CIVILIAN?<img src={SAD_GOBLIN_GIF} className="w-24 h-auto object-contain" onError={(e)=>e.target.outerHTML='üò≠'}/>:getRoleBadge(p.role).icon}</div><div className="clash-font text-xl text-center text-white">{p.role.replace('_',' ').toUpperCase()}</div></CardComp>)}</div><div className="mt-4"><Button full color="yellow" onClick={()=>setGameState('discussing')}>NEXT ROUND ‚è©</Button></div></Container>);

      if (gameState === 'game_over') return (<Container className="animate-pop"><header className="text-center mb-4 mt-2"><div className="text-6xl mb-2">{winnerData.team==='CIVILIANS'?'üõ°Ô∏è':(winnerData.team==='JESTER'?'üÉè':'üó°Ô∏è')}</div><h1 className={`clash-font text-3xl ${winnerData.team==='CIVILIANS'?'text-[#4176FF]':(winnerData.team==='JESTER'?'text-green-400':'text-[#FF4141]')}`}>{winnerData.team} WIN!</h1><p className="font-bold opacity-90 text-sm">{winnerData.reason}</p></header><CardComp className={`flex-1 overflow-y-auto mb-4 ${winnerData.team==='CIVILIANS'?'bg-blue-900/30':'bg-red-900/30'}`} noPadding><div className="p-3 space-y-2">{players.map(p=><div key={p.id} className={`flex justify-between bg-[#1c1f35]/50 p-2 rounded-xl ${justEliminated.some(e=>e.id===p.id)?'border-2 border-yellow-500':''}`}><span className="font-bold truncate">{p.avatar} {p.name}</span><span className={`text-xs font-bold px-2 py-1 rounded-lg ml-2 bg-slate-700`}>{p.role.replace('_',' ').toUpperCase()} {![ROLES.MR_WHITE,ROLES.JESTER,ROLES.BODYGUARD,ROLES.HUNTER,ROLES.ELECTRO].includes(p.role)&&`(${p.word})`}</span></div>)}</div></CardComp>{gameMode===MODES.STAT_GUESS&&targetCard&&<div className="text-center mb-4 opacity-80 bg-[#1c1f35]/30 p-2 rounded-xl"><div className="text-[10px] font-bold text-[#FFB900]">CARD WAS:</div><img src={getCardUrl(targetCard.name)} className="w-12 h-auto mx-auto"/><div className="text-[10px] font-bold">{targetCard.name}</div></div>}<div className="flex-shrink-0"><Button full color="yellow" onClick={()=>setGameState('setup')}>PLAY AGAIN üîÑ</Button></div></Container>);

      return null;
    };
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
